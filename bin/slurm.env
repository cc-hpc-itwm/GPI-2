#!/bin/sh

# Copyright (c) Fraunhofer ITWM, 2013-2024

# This file is part of GPI-2.

# GPI-2 is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public License
# version 3 as published by the Free Software Foundation.

# GPI-2 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with GPI-2. If not, see <http://www.gnu.org/licenses/>.

# ARGS:
# 1: machine file location
# 2: set NUMA?
# 3 and beyond: binary program <args>

program=$3
ARGS=""

count=1
for i in "$@"
do
    if [ $count -gt 3 ]; then
        ARGS="$ARGS ${i}"
    fi
    count=$((count+1))
done

export GASPI_SOCKET="$SLURM_LOCALID"
export GASPI_NRANKS="$SLURM_NPROCS"
export GASPI_RANK="$SLURM_PROCID"
export GASPI_MFILE="$1"
export GASPI_SET_NUMA_SOCKET="$2"

$program "$ARGS"
